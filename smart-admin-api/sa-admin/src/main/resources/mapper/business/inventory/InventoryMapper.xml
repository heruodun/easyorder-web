<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.lab1024.sa.admin.module.business.inventory.dao.InventoryDao">

    <!--  索引
    ALTER TABLE `t_inventory`
    ADD INDEX `idx_create_time` (`create_time`),
    ADD INDEX `idx_deleted_flag` (`deleted_flag`),
    ADD INDEX `idx_create_time_deleted_flag` (`deleted_flag`, `create_time`);

    唯一索引
    type,order_id
    -->
    <!--    in的时候 可以是插入也可以是更新 可能存在多次入库动作-->
    <insert id="inUpdate" parameterType="net.lab1024.sa.admin.module.business.inventory.domain.entity.InventoryEntity">
        INSERT INTO t_inventory
        (guige, count, danwei, detail, type, status, in_man, in_man_id, in_time, order_id)
        VALUES
            (#{guige}, #{count}, #{danwei}, #{detail}, #{type}, #{status}, #{inMan},#{inManId}, #{inTime}, #{orderId})
            ON DUPLICATE KEY UPDATE
                                 count = VALUES(count),
                                 danwei = VALUES(danwei),
                                 detail = VALUES(detail),
                                 guige = VALUES(guige),
                                 in_man = VALUES(inMan),
                                 in_man_id = VALUES(inManId),
                                 in_time = VALUES(inTime)
    </insert>

    <update id="outInventory" parameterType="net.lab1024.sa.admin.module.business.inventory.domain.entity.InventoryEntity">
        UPDATE t_inventory
        SET
            status = #{status},
            out_man = #{outMan},
            out_time = #{outTime},
            out_man_id = #{outManId},
            WHERE
                `type` = #{type} AND
                `order_id` = #{orderId}
    </update>

    <select id="querySummaryPage" resultType="net.lab1024.sa.admin.module.business.inventory.domain.vo.InventorySummaryVO">
        SELECT
        `type`,
        `guige`,
        `danwei`,
        SUM(`count`) AS total_count
        FROM
        `t_inventory`
        WHERE

        `deleted_flag` = 0

        <if test="queryForm.type != null">
            and type = #{queryForm.type}
        </if>

        <if test="queryForm.guige != null and queryForm.guige != ''">
            and guige = #{queryForm.guige}
        </if>

        <if test="queryForm.status != null">
            and status = #{queryForm.status}
        </if>

        <!--        <if test="queryForm.startTime != null">-->
        <!--            AND DATE_FORMAT(create_time, '%Y-%m-%d') >= #{queryForm.startTime}-->
        <!--        </if>-->

        <!--        <if test="queryForm.endTime != null">-->
        <!--            AND DATE_FORMAT(create_time, '%Y-%m-%d') &lt;= #{queryForm.endTime}-->
        <!--        </if>-->

        GROUP BY
        `type`,
        `guige`,
        `danwei`

        ORDER BY
        `type`,
        `guige`,
        `danwei`

        LIMIT #{limit} OFFSET #{offset};
    </select>

    <select id="querySummarySize" resultType="java.lang.Integer">
        SELECT
        count(*)
        FROM (

        SELECT
        `type`,
        `guige`,
        `danwei`,
        SUM(`count`) AS total_count
        FROM
        `t_inventory`
        WHERE

        `deleted_flag` = 0

        <if test="queryForm.type != null">
            and type = #{queryForm.type}
        </if>

        <if test="queryForm.guige != null and queryForm.guige != ''">
            and guige = #{queryForm.guige}
        </if>

        <if test="queryForm.status != null">
            and status = #{queryForm.status}
        </if>

        <!--            <if test="queryForm.startTime != null">-->
        <!--                AND DATE_FORMAT(create_time, '%Y-%m-%d') >= #{queryForm.startTime}-->
        <!--            </if>-->

        <!--            <if test="queryForm.endTime != null">-->
        <!--                AND DATE_FORMAT(create_time, '%Y-%m-%d') &lt;= #{queryForm.endTime}-->
        <!--            </if>-->

        GROUP BY
        `type`,
        `guige`,
        `danwei`
        ) AS summary;

    </select>



    <!-- 分页查询 -->
    <select id="queryPage" resultType="net.lab1024.sa.admin.module.business.inventory.domain.entity.InventoryEntity">
        SELECT
        *
        FROM t_inventory
        <where>

            <if test="queryForm.guige != null and queryForm.guige != ''">
                and guige = #{queryForm.guige}
            </if>

            <if test="queryForm.type != null">
                and type = #{queryForm.type}
            </if>

            <if test="queryForm.status != null">
                and status = #{queryForm.status}
            </if>

            <if test="queryForm.createTimeBegin != null">
                AND DATE_FORMAT(create_time, '%Y-%m-%d') >= #{queryForm.createTimeBegin}
            </if>

            <if test="queryForm.createTimeEnd != null">
                AND DATE_FORMAT(create_time, '%Y-%m-%d') &lt;= #{queryForm.createTimeEnd}
            </if>

        </where>

        ORDER BY create_time DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="querySize" resultType="java.lang.Integer">
        SELECT count(*)
        FROM t_inventory
        <where>

            <if test="queryForm.guige != null and queryForm.guige != ''">
                and guige = #{queryForm.guige}
            </if>

            <if test="queryForm.type != null">
                and type = #{queryForm.type}
            </if>

            <if test="queryForm.status != null">
                and status = #{queryForm.status}
            </if>

            <if test="queryForm.createTimeBegin != null">
                AND DATE_FORMAT(create_time, '%Y-%m-%d') >= #{queryForm.createTimeBegin}
            </if>

            <if test="queryForm.createTimeEnd != null">
                AND DATE_FORMAT(create_time, '%Y-%m-%d') &lt;= #{queryForm.createTimeEnd}
            </if>

        </where>
    </select>




    <update id="batchUpdateDeleted">
        update t_inventory set deleted_flag = #{deletedFlag}
        where id in
        <foreach collection="idList" open="(" close=")" separator="," item="item">
            #{item}
        </foreach>
    </update>

    <update id="updateDeleted">
        update t_inventory set deleted_flag = #{deletedFlag}
        where id = #{id}
    </update>
</mapper>